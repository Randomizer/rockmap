<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RockMap v0.3.0</title>
  <link rel="icon" href="data:,">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    :root { --panel-w: 200px; --accent: #ff4d4d; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; background: #111; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #controls {
      position: absolute; top: 10px; left: 10px; z-index: 1;
      width: var(--panel-w);
      background: rgba(255,255,255,.96);
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      padding: 12px;
      display: flex; flex-direction: column; gap: 8px;
    }
    #controls label { font-size: 12px; color: #333; }
    #controls select, #controls button {
      width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px;
    }
    #resetBtn { background: #f1f1f1; cursor: pointer; }
    #resetBtn:hover { background: #e8e8e8; }
    @media (max-width: 540px) {
      :root { --panel-w: 160px; }
      #controls select, #controls button { font-size: 12px; padding: 6px; }
    }
    /* Guitar marker (bright for dark map), with glow */
    .guitar-marker {
      width: 30px;
      height: 30px;
      background-image: url('data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%2064%2064%27%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3Cfilter%20id%3D%27glow%27%20x%3D%27-50%25%27%20y%3D%27-50%25%27%20width%3D%27200%25%27%20height%3D%27200%25%27%3E%0A%20%20%20%20%20%20%3CfeDropShadow%20dx%3D%270%27%20dy%3D%270%27%20stdDeviation%3D%272%27%20flood-color%3D%27%23ffffff%27%20flood-opacity%3D%270.55%27/%3E%0A%20%20%20%20%20%20%3CfeDropShadow%20dx%3D%270%27%20dy%3D%271%27%20stdDeviation%3D%271.5%27%20flood-color%3D%27%23000000%27%20flood-opacity%3D%270.35%27/%3E%0A%20%20%20%20%3C/filter%3E%0A%20%20%3C/defs%3E%0A%20%20%3C%21--%20neck%20--%3E%0A%20%20%3Crect%20x%3D%2736%27%20y%3D%278%27%20width%3D%2710%27%20height%3D%2722%27%20fill%3D%27%23f2f2f2%27%20stroke%3D%27%23ccc%27%20stroke-width%3D%271%27%20filter%3D%27url%28%23glow%29%27/%3E%0A%20%20%3C%21--%20head%20--%3E%0A%20%20%3Crect%20x%3D%2746%27%20y%3D%276%27%20width%3D%278%27%20height%3D%276%27%20rx%3D%271%27%20fill%3D%27%23e6e6e6%27%20stroke%3D%27%23bdbdbd%27%20stroke-width%3D%271%27%20filter%3D%27url%28%23glow%29%27/%3E%0A%20%20%3C%21--%20body%20--%3E%0A%20%20%3Cellipse%20cx%3D%2722%27%20cy%3D%2744%27%20rx%3D%2716%27%20ry%3D%2714%27%20fill%3D%27%23ff4d4d%27%20stroke%3D%27%23c0392b%27%20stroke-width%3D%272%27%20filter%3D%27url%28%23glow%29%27/%3E%0A%20%20%3Ccircle%20cx%3D%2722%27%20cy%3D%2744%27%20r%3D%276%27%20fill%3D%27%23ffffff%27%20stroke%3D%27%23bdbdbd%27%20stroke-width%3D%271%27%20filter%3D%27url%28%23glow%29%27/%3E%0A%3C/svg%3E');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.4)) drop-shadow(0 0 6px rgba(255,255,255,.35));
      transform-origin: bottom center;
      transition: transform .15s ease, filter .15s ease;
      cursor: pointer;
    }
    .guitar-marker:hover { transform: scale(1.1); filter: drop-shadow(0 3px 6px rgba(0,0,0,.6)) drop-shadow(0 0 8px rgba(255,255,255,.55)); }
    /* Popup style */
    .mapboxgl-popup-content { font-size: 14px; font-family: inherit; }
    .btn { display: inline-block; margin-top: 6px; padding: 6px 10px; border-radius: 6px; text-decoration: none; color: #fff; background: var(--accent); }
    .btn:hover { filter: brightness(1.05); }
  </style>
</head>
<body>
  <div id="controls">
    <button id="resetBtn" title="Reset all filters">Reset filters</button>
    <div>
      <label for="artistSelect">Artist</label>
      <select id="artistSelect"><option value="All">All</option></select>
    </div>
    <div>
      <label for="countrySelect">Country</label>
      <select id="countrySelect"><option value="All">All</option></select>
    </div>
    <div>
      <label for="monthSelect">Month</label>
      <select id="monthSelect"><option value="All">All</option></select>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYXJhbmV0IiwiYSI6ImNtZHI1eHoxNjBkeDkybnNibm9nMmpiOGoifQ.fAtpWpVeQgSG8XivujRiHw';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/dark-v11',
      center: [10, 50],
      zoom: 3
    });

    map.on('error', e => console.error('Mapbox error:', e && e.error));

    let allData = [];
    let markers = [];

    function fmtDate(iso) {
      try {
        const d = new Date(iso);
        const fmt = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        return fmt.replace(/\./g, ''); // remove dots in some locales
      } catch { return iso; }
    }

    function populateFilters(data) {
      const artists = [...new Set(data.map(e => e.artist))].sort();
      const countries = [...new Set(data.map(e => e.country))].sort();
      const months = [...new Set(data.map(e => e.date.slice(0,7)))].sort();

      const aSel = document.getElementById('artistSelect');
      const cSel = document.getElementById('countrySelect');
      const mSel = document.getElementById('monthSelect');

      artists.forEach(v => aSel.innerHTML += `<option>${v}</option>`);
      countries.forEach(v => cSel.innerHTML += `<option>${v}</option>`);
      months.forEach(v => mSel.innerHTML += `<option>${v}</option>`);
    }

    function filterEvents(data) {
      const a = document.getElementById('artistSelect').value;
      const c = document.getElementById('countrySelect').value;
      const m = document.getElementById('monthSelect').value;
      return data.filter(e =>
        (a === 'All' || e.artist === a) &&
        (c === 'All' || e.country === c) &&
        (m === 'All' || e.date.startsWith(m))
      );
    }

    function clearMarkers() { markers.forEach(m => m.remove()); markers = []; }

    function guitarMarkerEl(title) {
      const el = document.createElement('div');
      el.className = 'guitar-marker';
      el.title = title || '';
      return el;
    }

    function updateMap(events) {
      clearMarkers();
      events.forEach(e => {
        const el = guitarMarkerEl(`${e.artist} â€” ${e.venue}, ${e.city}`);
        const marker = new mapboxgl.Marker({ element: el, anchor: 'bottom' })
          .setLngLat([e.lon, e.lat])
          .setPopup(new mapboxgl.Popup().setHTML(
            `<strong>${e.artist}</strong><br>${e.venue}, ${e.city}<br>${fmtDate(e.date)}<br><a class='btn' href='${e.ticket_url}' target='_blank' rel='noopener'>Tickets</a>`
          ))
          .addTo(map);
        markers.push(marker);
      });
    }

    function zoomTo(events) {
      if (!events || events.length === 0) { map.easeTo({ center: [10,50], zoom: 3, duration: 600 }); return; }
      if (events.length === 1) { const e = events[0]; map.easeTo({ center: [e.lon, e.lat], zoom: 6, duration: 600 }); return; }
      const b = new mapboxgl.LngLatBounds();
      events.forEach(e => b.extend([e.lon, e.lat]));
      map.fitBounds(b, { padding: 80, duration: 600 });
    }

    function refresh() {
      const f = filterEvents(allData);
      updateMap(f);
      zoomTo(f);
    }

    // Ensure map is loaded before adding markers/fit
    map.on('load', () => {
      fetch('events.json')
        .then(r => r.json())
        .then(data => {
          allData = data;
          populateFilters(allData);
          refresh();
        });
    });

    document.getElementById('artistSelect').addEventListener('change', refresh);
    document.getElementById('countrySelect').addEventListener('change', refresh);
    document.getElementById('monthSelect').addEventListener('change', refresh);
    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('artistSelect').value = 'All';
      document.getElementById('countrySelect').value = 'All';
      document.getElementById('monthSelect').value = 'All';
      refresh();
    });
  </script>
</body>
</html>
