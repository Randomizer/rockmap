<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RockMap v0.2.2</title>
  <link rel="icon" href="data:,">
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #controls {
      position: absolute; top: 10px; left: 10px;
      background: white; padding: 10px; border-radius: 6px;
      z-index: 1; box-shadow: 0 0 5px rgba(0,0,0,0.3);
      display: flex; flex-direction: column; gap: 5px;
      width: 160px;
    }
    #controls select, #controls button {
      width: 100%;
      padding: 5px;
    }
    @media (max-width: 500px) {
      #controls { width: 130px; padding: 6px; }
      #controls select, #controls button { font-size: 12px; padding: 3px; }
    }
  </style>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
</head>
<body>
<div id="controls">
  <button id="resetBtn">Reset Filters</button>
  <select id="countrySelect"><option>All</option></select>
  <select id="monthSelect"><option>All</option></select>
</div>
<div id="map"></div>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiYXJhbmV0IiwiYSI6ImNtZHI1eHoxNjBkeDkybnNibm9nMmpiOGoifQ.fAtpWpVeQgSG8XivujRiHw';
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/streets-v11',
  center: [10, 50],
  zoom: 3
});

// Log any map errors
map.on('error', e => console.error('Mapbox error:', e && e.error));

let allData = [];

function populateFilters(data) {
  const countries = [...new Set(data.map(e => e.country))].sort();
  const months = [...new Set(data.map(e => e.date.slice(0,7)))].sort();
  const countrySelect = document.getElementById("countrySelect");
  const monthSelect = document.getElementById("monthSelect");
  countries.forEach(c => countrySelect.innerHTML += `<option>${c}</option>`);
  months.forEach(m => monthSelect.innerHTML += `<option>${m}</option>`);
}

function filterEvents(data) {
  const country = document.getElementById("countrySelect").value;
  const month = document.getElementById("monthSelect").value;
  return data.filter(e =>
    (country === "All" || e.country === country) &&
    (month === "All" || e.date.startsWith(month))
  );
}

function updateMap(events) {
  document.querySelectorAll('.marker').forEach(m => m.remove());
  events.forEach(e => {
    const el = document.createElement('div');
    el.className = 'marker';
    el.style.width = '12px';
    el.style.height = '12px';
    el.style.backgroundColor = 'red';
    el.style.borderRadius = '50%';
    new mapboxgl.Marker(el)
      .setLngLat([e.lon, e.lat])
      .setPopup(new mapboxgl.Popup().setHTML(
        `<strong>${e.artist}</strong><br>${e.city}, ${e.venue}<br>${e.date}<br><a href="${e.ticket_url}" target="_blank">Tickets</a>`
      ))
      .addTo(map);
  });
}

function zoomTo(events) {
  if (!events || events.length === 0) {
    map.easeTo({ center: [10, 50], zoom: 3, duration: 800 });
    return;
  }
  if (events.length === 1) {
    const e = events[0];
    map.easeTo({ center: [e.lon, e.lat], zoom: 6, duration: 800 });
    return;
  }
  const bounds = new mapboxgl.LngLatBounds();
  events.forEach(e => bounds.extend([e.lon, e.lat]));
  map.fitBounds(bounds, { padding: 60, duration: 800 });
}

fetch('events.json')
  .then(r => r.json())
  .then(data => {
    allData = data;
    populateFilters(allData);
    const initial = filterEvents(allData);
    updateMap(initial);
    zoomTo(initial);
  });

document.getElementById("monthSelect").addEventListener("change", () => {
  const f = filterEvents(allData);
  updateMap(f);
  zoomTo(f);
});
document.getElementById("countrySelect").addEventListener("change", () => {
  const f = filterEvents(allData);
  updateMap(f);
  zoomTo(f);
});
document.getElementById("resetBtn").addEventListener("click", () => {
  document.getElementById("monthSelect").value = 'All';
  document.getElementById("countrySelect").value = 'All';
  const reset = filterEvents(allData);
  updateMap(reset);
  zoomTo(reset);
});
</script>
</body>
</html>
